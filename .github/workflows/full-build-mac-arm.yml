name: Full Build (MacOS ARM64 Only)

on:
  workflow_dispatch:
    inputs:
      publish_to_s3:
        description: "Force S3 publishing even when not on develop"
        required: false
        default: "false"
      skip_docker_trigger:
        description: "Skip downstream docker workflow trigger"
        required: false
        default: "false"

concurrency:
  group: full-build-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  packages: write
  id-token: write

env:
  BUILD_TYPE: Release
  OPENSTUDIO_SOURCE: OpenStudio
  OPENSTUDIO_BUILD: OS-build-release-v2
  PY_VERSION: "3.12.2"
  RUBY_VERSION: "3.2.2"
  AWS_S3_BUCKET: openstudio-ci-builds

jobs:
  macos:
    name: ${{ matrix.display_name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-arm64
            display_name: macOS ARM64 (Apple Silicon)
            runner: macos-14
            test_suffix: macOS-arm64
            dmg_glob: "*.dmg"
            tar_glob: "*OpenStudio*arm64.tar.gz"
            exclude_regex: "GeometryFixture.Plane_RayIntersection|ModelFixture.Space_Convexity|ISOModelFixture.SimModel"
    defaults:
      run:
        shell: bash
    env:
      MAX_BUILD_THREADS: 2
      CTEST_PARALLEL_LEVEL: 2
    steps:
      # --- UNIQUE MAC PREP ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      - name: Install Python Dependencies
        run: |
          pip install pytest numpy

      # --- COMPOSITE ACTIONS ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-env
        with:
          platform: ${{ matrix.platform }}
          ruby_version: ${{ env.RUBY_VERSION }}
          build_dir: ${{ env.OPENSTUDIO_BUILD }}

      - uses: ./.github/actions/build-and-test
        id: build_and_test_steps
        with:
          build_dir: ${{ env.OPENSTUDIO_BUILD }}
          platform_name: ${{ matrix.platform }}
          py_version: ${{ env.PY_VERSION }}
          cpack_generators: "DragNDrop;TGZ"
          parallel_level: ${{ env.MAX_BUILD_THREADS }}
          ctest_parallel_level: ${{ env.CTEST_PARALLEL_LEVEL }}
          exclude_regex: ${{ matrix.exclude_regex }}

      - name: Create packages
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        run: |
          set -euo pipefail
          . ./conanbuild.sh
          echo "PATH: $PATH"
          echo "Checking for cpack..."
          which cpack || cmake --version
          cpack -B .

      - name: Copy Testing tree with suffix
        if: always()
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        run: |
          set -euo pipefail
          if [ -d Testing ]; then
            cp -r Testing "Testing-${{ matrix.test_suffix }}"
          else
            echo "::warning::Testing directory not found; skipping copy"
            mkdir -p "Testing-${{ matrix.test_suffix }}"
          fi

      - name: Configure AWS credentials
        if: ${{ github.ref == 'refs/heads/develop' || inputs.publish_to_s3 == 'true' || github.event.inputs.publish_to_s3 == 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: Publish installers to S3
        if: ${{ github.ref == 'refs/heads/develop' || inputs.publish_to_s3 == 'true' || github.event.inputs.publish_to_s3 == 'true' }}
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        env:
          S3_PREFIX: ${{ github.ref_type == 'tag' && format('releases/{0}', github.ref_name) || format('{0}', github.ref_name) }}
        run: |
          set -euo pipefail
          echo "Uploading artifacts to s3://${AWS_S3_BUCKET}/${S3_PREFIX}" > /dev/stderr

          # Upload unsigned DMG files, skipping any signed ones for now as requested.
          echo "Uploading unsigned DMG files..."
          for file in ${{ matrix.dmg_glob }}; do
            if [ -f "$file" ]; then
              key="${S3_PREFIX}/$(basename "$file")"
              aws s3 cp "$file" "s3://${AWS_S3_BUCKET}/${key}" --acl public-read
              md5 "$file"
            fi
          done

          # Upload TAR.GZ files
          for file in ${{ matrix.tar_glob }}; do
            if [ -f "$file" ]; then
              key="${S3_PREFIX}/$(basename "$file")"
              aws s3 cp "$file" "s3://${AWS_S3_BUCKET}/${key}" --acl public-read
              md5 "$file"
            fi
          done

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: packages-macos-arm64
          path: |
            ${{ env.OPENSTUDIO_BUILD }}/*.dmg
            ${{ env.OPENSTUDIO_BUILD }}/*.tar.gz

      - name: Fail job on test failures
        if: ${{ steps.build_and_test_steps.outputs.ctest_exit_code != '0' }}
        run: |
          echo "::error::CTest suite failed with exit code ${{ steps.build_and_test_steps.outputs.ctest_exit_code }}"
          exit 1