name: Full Build

on:
  push:
    branches:
      - develop
    tags:
      - "v*"
  schedule:
    # Run nightly at 8 PM ET (midnight UTC during EST, 1 AM UTC during EDT)
    # Using 1 AM UTC to cover EDT (daylight saving time)
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      publish_to_s3:
        description: "Force S3 publishing even when not on develop"
        required: false
        default: "false"
      skip_docker_trigger:
        description: "Skip downstream docker workflow trigger"
        required: false
        default: "false"
  workflow_call:
    inputs:
      publish_to_s3:
        type: string
        required: false
        default: "false"
      skip_docker_trigger:
        type: string
        required: false
        default: "false"

concurrency:
  group: full-build-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  packages: write
  id-token: write

env:
  BUILD_TYPE: Release
  OPENSTUDIO_SOURCE: OpenStudio
  OPENSTUDIO_BUILD: OS-build-release-v2
  PY_VERSION: "3.12.2"
  RUBY_VERSION: "3.2.2"
  AWS_S3_BUCKET: openstudio-ci-builds

jobs:
  linux-x64:
    name: ${{ matrix.display_name }}
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.container_image }}
      options: ${{ matrix.container_options }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: centos-9-x64
            display_name: CentOS 9 (AlmaLinux) x64
            runner: ubuntu-22.04
            container_image: nrel/openstudio-cmake-tools:almalinux9-main
            container_options: "-u root -e LANG=en_US.UTF-8"
            test_suffix: CentOS-9
            pip_package: false
            docker_trigger: false
            upload_globs: |
              *.rpm
              *OpenStudio*x86_64.tar.gz
            cpack_generators: "RPM;TGZ"
            max_jobs: 2
            ctest_parallel_level: 2
            exclude_regex: "^(BCLFixture.RemoteBCLMetaSearchTest)$"
          - platform: ubuntu-2204-x64
            display_name: Ubuntu 22.04 x64
            runner: ubuntu-22.04
            container_image: nrel/openstudio-cmake-tools:jammy-main
            container_options: "-u root -e LANG=en_US.UTF-8"
            test_suffix: Ubuntu-2204
            pip_package: true
            docker_trigger: true
            upload_globs: |
              *.deb
              *OpenStudio*x86_64.tar.gz
            cpack_generators: "DEB;TGZ"
            max_jobs: 2
            ctest_parallel_level: 2
            exclude_regex: "^(RubyTest-UUID_Test-uuid_hash)$"
          - platform: ubuntu-2404-x64
            display_name: Ubuntu 24.04 x64
            runner: ubuntu-24.04
            container_image: nrel/openstudio-cmake-tools:noble-main
            container_options: "-u root -e LANG=en_US.UTF-8"
            test_suffix: Ubuntu-2404
            pip_package: false
            docker_trigger: false
            upload_globs: |
              *.deb
              *OpenStudio*x86_64.tar.gz
            cpack_generators: "DEB;TGZ"
            max_jobs: 2
            ctest_parallel_level: 2
            exclude_regex: "^(CLITest-UUID_Test-uuid_hash)$"
          - platform: ubuntu-2204-arm64
            display_name: Ubuntu 22.04 ARM64
            runner: ubuntu-22.04-arm
            container_image: nrel/openstudio-cmake-tools:jammy-main
            container_options: "-u root -e LANG=en_US.UTF-8"
            test_suffix: Ubuntu-2204-ARM64
            pip_package: false
            docker_trigger: false
            upload_globs: |
              *.deb
              *OpenStudio*aarch64.tar.gz
            cpack_generators: "DEB;TGZ"
            max_jobs: 2
            ctest_parallel_level: 1
            exclude_regex: "^(SqlFileFixture.AnnualTotalCosts)$"
          - platform: ubuntu-2404-arm64
            display_name: Ubuntu 24.04 ARM64
            runner: ubuntu-24.04-arm
            container_image: nrel/openstudio-cmake-tools:noble-main
            container_options: "-u root -e LANG=en_US.UTF-8"
            test_suffix: Ubuntu-2404-ARM64
            pip_package: false
            docker_trigger: false
            upload_globs: |
              *.deb
              *OpenStudio*aarch64.tar.gz
            cpack_generators: "DEB;TGZ"
            max_jobs: 2
            ctest_parallel_level: 1
            exclude_regex: "^(SqlFileFixture.AnnualTotalCosts|CLITest-UUID_Test-uuid_hash|RubyTest-UUID_Test-uuid_hash)$"
    defaults:
      run:
        shell: bash
    env:
      MAX_BUILD_THREADS: ${{ matrix.max_jobs }}
      CTEST_PARALLEL_LEVEL: ${{ matrix.ctest_parallel_level }}
    steps:
      # --- UNIQUE LINUX PREP ---
      - name: Enable Swap Space (attempt)
        # Runs inside the container as root; attempts swap if privileged
        run: |
          set -euo pipefail
          if grep -q '/swapfile' /proc/swaps; then
            echo "::notice::Swap already active"
          else
            if (fallocate -l 4G /swapfile && chmod 600 /swapfile && mkswap /swapfile && swapon /swapfile); then
              echo "::notice::Enabled 4GB swap space (container)"
            else
              echo "::warning::Failed to enable swap (likely insufficient privilege); continuing"
            fi
          fi
          if command -v free &> /dev/null; then
            free -h || true
          fi

      - name: Pre-install Ruby (CentOS 9)
        if: matrix.platform == 'centos-9-x64'
        run: |
          set -euo pipefail
          
          # Install dependencies for Ruby build
          # We need these to ensure Ruby builds with SSL, Readline, etc.
          dnf install -y git patch bzip2 openssl-devel readline-devel zlib-devel libyaml-devel libffi-devel

          # Install ruby-build
          git clone https://github.com/rbenv/ruby-build.git /tmp/ruby-build
          /tmp/ruby-build/install.sh
          rm -rf /tmp/ruby-build

          # Install Ruby
          RUBY_PATH="$RUNNER_TOOL_CACHE/Ruby/${{ env.RUBY_VERSION }}/x64"
          echo "Compiling Ruby ${{ env.RUBY_VERSION }} to $RUBY_PATH..."
          ruby-build "${{ env.RUBY_VERSION }}" "$RUBY_PATH"
          touch "$RUBY_PATH.complete"

      - name: Enable Legacy Crypto Policies (CentOS 9)
        if: matrix.platform == 'centos-9-x64'
        run: |
          update-crypto-policies --set LEGACY
          echo "::notice::Crypto policy set to LEGACY to allow BCL downloads"    

      # --- COMPOSITE ACTION CALLS ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-env
        with:
          platform: ${{ matrix.platform }}
          ruby_version: ${{ env.RUBY_VERSION }}
          build_dir: ${{ env.OPENSTUDIO_BUILD }}

      - uses: ./.github/actions/build-and-test
        id: build_and_test_steps
        with:
          build_dir: ${{ env.OPENSTUDIO_BUILD }}
          platform_name: ${{ matrix.platform }}
          py_version: ${{ env.PY_VERSION }}
          cpack_generators: ${{ matrix.cpack_generators }}
          pip_package: ${{ matrix.pip_package }}
          parallel_level: ${{ matrix.max_jobs }}
          ctest_parallel_level: ${{ matrix.ctest_parallel_level }}
          exclude_regex: ${{ matrix.exclude_regex }}

      # --- POST BUILD (Specific to Linux Packaging) ---
      - name: Create packages
        working-directory: ${{ github.workspace }}/${{ env.OPENSTUDIO_BUILD }}
        run: |
          set -euo pipefail
          . ./conanbuild.sh
          export PATH="$(pwd):$PATH"
          
          # Fix for missing ctest/cpack in PATH
          if command -v cmake &> /dev/null; then
            CMAKE_REAL_PATH=$(readlink -f "$(command -v cmake)")
            CMAKE_DIR=$(dirname "$CMAKE_REAL_PATH")
            export PATH="$CMAKE_DIR:$PATH"
          fi
          echo "PATH: $PATH"
          echo "Checking for cpack..."
          which cpack || cmake --version
          cpack -B .

      - name: Copy Testing tree with suffix
        if: always()
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        run: |
          set -euo pipefail
          if [ -d Testing ]; then
            cp -r Testing "Testing-${{ matrix.test_suffix }}"
          else
            echo "::warning::Testing directory not found; skipping copy"
            mkdir -p "Testing-${{ matrix.test_suffix }}"
          fi

      - name: Configure AWS credentials
        if: ${{ matrix.upload_globs != '' && (github.ref == 'refs/heads/develop' || inputs.publish_to_s3 == 'true' || github.event.inputs.publish_to_s3 == 'true') }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: Publish installers to S3
        if: ${{ matrix.upload_globs != '' && (github.ref == 'refs/heads/develop' || inputs.publish_to_s3 == 'true' || github.event.inputs.publish_to_s3 == 'true') }}
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        env:
          S3_PREFIX: ${{ github.ref_type == 'tag' && format('releases/{0}', github.ref_name) || format('{0}', github.ref_name) }}
        run: |
          set -euo pipefail
          echo "Uploading artifacts to s3://${AWS_S3_BUCKET}/${S3_PREFIX}" > /dev/stderr
          while IFS= read -r pattern; do
            [ -z "$pattern" ] && continue
            for file in $(find . -maxdepth 1 -type f -name "$pattern" -print); do
              key="${S3_PREFIX}/$(basename "$file")"
              if aws s3api head-object --bucket "$AWS_S3_BUCKET" --key "$key" 2>/dev/null; then
                echo "Skipping existing ${key}" > /dev/stderr
                continue
              fi
              aws s3 cp "$file" "s3://${AWS_S3_BUCKET}/${key}" --acl public-read
              if command -v md5sum >/dev/null 2>&1; then
                md5sum "$file"
              fi
            done
          done <<'EOF'
          ${{ matrix.upload_globs }}
          EOF

      - name: Trigger docker workflow update
        if: ${{ matrix.docker_trigger && steps.build_and_test_steps.outputs.ctest_exit_code == '0' && github.ref == 'refs/heads/develop' && (inputs.skip_docker_trigger != 'true') && (github.event.inputs.skip_docker_trigger != 'true') }}
        env:
          GH_TOKEN: ${{ secrets.GH_DOCKER_TRIGGER_TOKEN || secrets.GITHUB_TOKEN }}
          REF_NAME: ${{ github.ref_name }}
          REF_TYPE: ${{ github.ref_type }}
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        run: |
          set -euo pipefail
          gh workflow run docker-build.yml \
            --ref "$REF_NAME" \
            -f ref_name="$REF_NAME" \
            -f ref_type="$REF_TYPE"

      - name: Fail job on test failures
        if: ${{ steps.build_and_test_steps.outputs.ctest_exit_code != '0' }}
        run: |
          echo "::error::CTest suite failed with exit code ${{ steps.build_and_test_steps.outputs.ctest_exit_code }}"
          exit 1

  macos:
    name: ${{ matrix.display_name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-x64
            display_name: macOS x64 (Intel)
            runner: macos-15-intel
            test_suffix: macOS-x64
            dmg_glob: "*.dmg"
            tar_glob: "*OpenStudio*x86_64.tar.gz"
            # exclude_regex: "^('BCLFixture.BCLComponent'|'BCLFixture.LocalBCL_AuthKey'|'BCLFixture.RemoteBCLTest'|'BCLFixture.RemoteBCLTest2'|'BCLFixture.GetComponentByUID'|'BCLFixture.RemoteBCLMetaSearchTest'|'BCLFixture.RemoteBCL_EncodingURI'|'BCLFixture.RemoteBCL_BCLSearchResult')$"
          - platform: macos-arm64
            display_name: macOS ARM64 (Apple Silicon)
            runner: macos-14
            test_suffix: macOS-arm64
            dmg_glob: "*.dmg"
            tar_glob: "*OpenStudio*arm64.tar.gz"
            # exclude_regex: "^('BCLFixture.BCLComponent'|'BCLFixture.LocalBCL_AuthKey'|'BCLFixture.RemoteBCLTest'|'BCLFixture.RemoteBCLTest2'|'BCLFixture.GetComponentByUID'|'BCLFixture.RemoteBCLMetaSearchTest'|'BCLFixture.RemoteBCL_EncodingURI'|'BCLFixture.RemoteBCL_BCLSearchResult')$"
    defaults:
      run:
        shell: bash
    env:
      MAX_BUILD_THREADS: 2
      CTEST_PARALLEL_LEVEL: 2
    steps:
      # --- UNIQUE MAC PREP ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      # --- COMPOSITE ACTIONS ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-env
        with:
          platform: ${{ matrix.platform }}
          ruby_version: ${{ env.RUBY_VERSION }}
          build_dir: ${{ env.OPENSTUDIO_BUILD }}

      - uses: ./.github/actions/build-and-test
        id: build_and_test_steps
        with:
          build_dir: ${{ env.OPENSTUDIO_BUILD }}
          platform_name: ${{ matrix.platform }}
          py_version: ${{ env.PY_VERSION }}
          cpack_generators: "DragNDrop;TGZ"
          parallel_level: ${{ env.MAX_BUILD_THREADS }}
          ctest_parallel_level: ${{ env.CTEST_PARALLEL_LEVEL }}
          exclude_regex: ${{ matrix.exclude_regex }}

      - name: Create packages
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        run: |
          set -euo pipefail
          . ./conanbuild.sh
          echo "PATH: $PATH"
          echo "Checking for cpack..."
          which cpack || cmake --version
          cpack -B .

      # --- UNIQUE MAC SIGNING ---
      - name: Code sign and notarize macOS packages
        if: ${{ github.ref == 'refs/heads/develop' || inputs.publish_to_s3 == 'true' || github.event.inputs.publish_to_s3 == 'true' }}
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        env:
          APPLE_CERT_DATA: ${{ secrets.APPLE_CERT_DATA }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_DEV_ID: ${{ secrets.APPLE_DEV_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID_USERNAME: ${{ secrets.APPLE_ID_USERNAME }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        run: |
          set -euo pipefail
          
          # Check if signing credentials are configured
          if [ -z "$APPLE_CERT_DATA" ] || [ -z "$APPLE_CERT_PASSWORD" ]; then
            echo "::warning::Apple signing certificates not configured"
            echo "::warning::Skipping code signing. Configure APPLE_CERT_DATA and APPLE_CERT_PASSWORD secrets."
            exit 0
          fi
          
          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$APPLE_CERT_DATA" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychain -d user | sed s/\"//g)
          
          # Sign DMG files
          mkdir -p signed
          for dmg in ${{ matrix.dmg_glob }}; do
            if [ -f "$dmg" ]; then
              echo "Signing $dmg..."
              codesign --force --sign "$APPLE_DEV_ID" --timestamp --options runtime "$dmg" || {
                echo "::warning::Failed to sign $dmg"
                cp "$dmg" "signed/$(basename "$dmg")"
                continue
              }
              
              # Notarize if credentials available
              if [ -n "$APPLE_ID_USERNAME" ] && [ -n "$APPLE_ID_PASSWORD" ]; then
                echo "Notarizing $dmg..."
                xcrun notarytool submit "$dmg" \
                  --apple-id "$APPLE_ID_USERNAME" \
                  --password "$APPLE_ID_PASSWORD" \
                  --team-id "$APPLE_TEAM_ID" \
                  --wait || echo "::warning::Notarization failed for $dmg"
                
                # Staple the notarization ticket
                xcrun stapler staple "$dmg" || echo "::warning::Stapling failed for $dmg"
              fi
              
              cp "$dmg" "signed/$(basename "$dmg")"
            fi
          done
          
          # Cleanup
          security delete-keychain "$KEYCHAIN_PATH" || true
          rm -f "$CERT_PATH"
          
          echo "Code signing completed"

      - name: Copy Testing tree with suffix
        if: always()
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        run: |
          set -euo pipefail
          if [ -d Testing ]; then
            cp -r Testing "Testing-${{ matrix.test_suffix }}"
          else
            echo "::warning::Testing directory not found; skipping copy"
            mkdir -p "Testing-${{ matrix.test_suffix }}"
          fi

      - name: Configure AWS credentials
        if: ${{ github.ref == 'refs/heads/develop' || inputs.publish_to_s3 == 'true' || github.event.inputs.publish_to_s3 == 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: Publish installers to S3
        if: ${{ github.ref == 'refs/heads/develop' || inputs.publish_to_s3 == 'true' || github.event.inputs.publish_to_s3 == 'true' }}
        working-directory: ${{ env.OPENSTUDIO_BUILD }}
        env:
          S3_PREFIX: ${{ github.ref_type == 'tag' && format('releases/{0}', github.ref_name) || format('{0}', github.ref_name) }}
        run: |
          set -euo pipefail
          echo "Uploading artifacts to s3://${AWS_S3_BUCKET}/${S3_PREFIX}" > /dev/stderr

          # Upload signed DMG files if they exist, otherwise upload unsigned
          if [ -d "signed" ] && [ "$(ls -A signed/*.dmg 2>/dev/null)" ]; then
            echo "Uploading signed DMG files..."
            for file in signed/*.dmg; do
              if [ -f "$file" ]; then
                key="${S3_PREFIX}/$(basename "$file")"
                aws s3 cp "$file" "s3://${AWS_S3_BUCKET}/${key}" --acl public-read
                md5 "$file"
              fi
            done
          else
            echo "Uploading unsigned DMG files..."
            for file in ${{ matrix.dmg_glob }}; do
              if [ -f "$file" ]; then
                key="${S3_PREFIX}/$(basename "$file")"
                aws s3 cp "$file" "s3://${AWS_S3_BUCKET}/${key}" --acl public-read
                md5 "$file"
              fi
            done
          fi

          # Upload TAR.GZ files
          for file in ${{ matrix.tar_glob }}; do
            if [ -f "$file" ]; then
              key="${S3_PREFIX}/$(basename "$file")"
              aws s3 cp "$file" "s3://${AWS_S3_BUCKET}/${key}" --acl public-read
              md5 "$file"
            fi
          done

      - name: Fail job on test failures
        if: ${{ steps.build_and_test_steps.outputs.ctest_exit_code != '0' }}
        run: |
          echo "::error::CTest suite failed with exit code ${{ steps.build_and_test_steps.outputs.ctest_exit_code }}"
          exit 1

  windows:
    name: Windows 2022 x64
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    env:
      MAX_BUILD_THREADS: 3
      CTEST_PARALLEL_LEVEL: 2
      PLATFORM: windows
    steps:
      # --- UNIQUE WIN PREP ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Patch bundle_git lockfile for Windows
        run: |
          Set-Location src/cli/test/bundle_git
          bundle lock --add-platform x64-mingw-ucrt

      - name: Install Doxygen
        run: choco install doxygen.install -y

      - name: Install Python Dependencies
        run: pip install pytest numpy

      # --- COMPOSITE ACTIONS ---
      - uses: ./.github/actions/setup-env
        with:
          platform: ${{ env.PLATFORM }}
          ruby_version: ${{ env.RUBY_VERSION }}
          build_dir: ${{ env.OPENSTUDIO_BUILD }}
          install_qt: 'true'

      - uses: ./.github/actions/build-and-test
        id: build_and_test_steps
        with:
          build_dir: ${{ env.OPENSTUDIO_BUILD }}
          platform_name: ${{ env.PLATFORM }}
          py_version: ${{ env.PY_VERSION }}
          cpack_generators: "IFW;ZIP"
          cmake_args: "-DBUILD_DOCUMENTATION:BOOL=ON -DBUILD_CSHARP_BINDINGS:BOOL=OFF"
          parallel_level: ${{ env.MAX_BUILD_THREADS }}
          ctest_parallel_level: ${{ env.CTEST_PARALLEL_LEVEL }}
          exclude_regex: ${{ matrix.exclude_regex }}

      # --- UNIQUE WIN PACKAGING/SIGNING ---

      - name: Archive Testing directory
        if: always()
        shell: pwsh
        working-directory: ${{ github.workspace }}/${{ env.OPENSTUDIO_BUILD }}
        run: |
          if (Test-Path Testing) {
            Compress-Archive -Path Testing -DestinationPath Testing-Windows-2022.zip -Force
          } else {
            Write-Host "::warning::Testing directory not found; creating empty archive"
            New-Item -ItemType Directory -Path Testing-temp | Out-Null
            Compress-Archive -Path Testing-temp -DestinationPath Testing-Windows-2022.zip -Force
            Remove-Item -Recurse Testing-temp
          }

      - name: Upload Testing artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Testing-windows-2022-x64-${{ github.sha }}
          path: |
            ${{ github.workspace }}/${{ env.OPENSTUDIO_BUILD }}/Testing-Windows-2022.zip

      # CODE SIGNING - AWS Signing Service
      - name: Setup Node.js
        if: always()
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Create .env file for Signing
        if: always()
        run: |
          echo "ACCESS_KEY=${{ secrets.AWS_SIGNING_ACCESS_KEY }}" > "${{ github.workspace }}/.github/signing-client/.env"
          echo "SECRET_KEY=${{ secrets.AWS_SIGNING_SECRET_KEY }}" >> "${{ github.workspace }}/.github/signing-client/.env"
          echo "AWS_S3_BUCKET=${{ env.AWS_S3_BUCKET }}" >> "${{ github.workspace }}/.github/signing-client/.env"
        shell: pwsh

      - name: Code sign installer
        if: always()
        shell: pwsh
        env:
          AWS_S3_BUCKET: openstudio-ci-builds
          QTIFW_PATH: C:\Qt\Tools\QtInstallerFramework\4.1\bin
        working-directory: ${{ github.workspace }}/${{ env.OPENSTUDIO_BUILD }}
        run: |
          # ---------------------------------------------------------
          # 1. Add QtIFW to PATH (Required for CPack)
          # ---------------------------------------------------------
          $qtToolsPath = "C:\Qt\Tools"
          $binaryCreator = Get-ChildItem -Path $qtToolsPath -Recurse -Filter "binarycreator.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($binaryCreator) {
            $qtIfwBinPath = $binaryCreator.DirectoryName
            Write-Host "Found QtIFW at: $qtIfwBinPath"
            $env:PATH = "$qtIfwBinPath;$env:PATH"
          } else {
            Write-Host "::error::QtIFW (binarycreator.exe) not found in $qtToolsPath"
            Get-ChildItem -Path $qtToolsPath -Recurse -Depth 2 | Select-Object FullName
            exit 1
          }

          # ---------------------------------------------------------
          # 2. Create .env file for Signing (User Provided Method)
          # ---------------------------------------------------------
          $signingDir = "${{ github.workspace }}/.github/signing-client"
          $envFile = "$signingDir/.env"
          
          if (-not (Test-Path $envFile)) {
            Write-Error "::error::.env file not found at $envFile"
            exit 1
          }

          # ---------------------------------------------------------
          # 3. Sign Executables
          # ---------------------------------------------------------
          $exeFiles = Get-ChildItem -Filter *.exe -ErrorAction SilentlyContinue
          if ($exeFiles) {
            Write-Host "Found $($exeFiles.Count) executable files to sign"
            Compress-Archive -Path *.exe -DestinationPath build-signed.zip -Force
            
            Push-Location $signingDir
            $zipPath = Resolve-Path "..\..\${{ env.OPENSTUDIO_BUILD }}\build-signed.zip"
            
            # Execute Node Script
            node code-signing.js "$zipPath" -t 4800000
            Pop-Location
            
            if (Test-Path "build-signed.signed.zip") {
              Expand-Archive -Path "build-signed.signed.zip" -DestinationPath . -Force
              Write-Host "Successfully expanded signed executables"
            } else {
              Write-Host "::warning::Signed zip file not created"
            }
          }

          # ---------------------------------------------------------
          # 4. Run CPack (Generates Installer)
          # ---------------------------------------------------------
          Write-Host "Running CPack..."
          cpack -G "IFW;ZIP" -B .
          
          # ---------------------------------------------------------
          # 5. Sign Installer
          # ---------------------------------------------------------
          $installerFiles = Get-ChildItem -Filter "OpenStudio*.exe" -ErrorAction SilentlyContinue
          if ($installerFiles) {
            Write-Host "Found $($installerFiles.Count) installer file(s) to sign"
            Compress-Archive -Path OpenStudio*.exe -DestinationPath "installer-signed.zip" -Force
            
            Push-Location $signingDir
            $instZipPath = Resolve-Path "..\..\${{ env.OPENSTUDIO_BUILD }}\installer-signed.zip"
            
            # Execute Node Script
            node code-signing.js "$instZipPath" -t 4800000
            Pop-Location
            
            if (Test-Path "installer-signed.signed.zip") {
              if (-not (Test-Path signed)) { New-Item -ItemType Directory -Path signed | Out-Null }
              Expand-Archive -Path "installer-signed.signed.zip" -DestinationPath signed -Force
              Write-Host "Code signing completed successfully"
            } else {
              Write-Host "::warning::Signed installer zip not created"
            }
          } else {
            Write-Host "::warning::No installer files found to sign. CPack likely failed."
          }

      - name: Upload build outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: packages-windows-2022-x64-${{ github.sha }}
          path: |
            ${{ github.workspace }}/${{ env.OPENSTUDIO_BUILD }}/*.exe
            ${{ github.workspace }}/${{ env.OPENSTUDIO_BUILD }}/*.zip

      - name: Configure AWS credentials
        if: ${{ github.ref == 'refs/heads/develop' || inputs.publish_to_s3 == 'true' || github.event.inputs.publish_to_s3 == 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: Publish signed artifacts to S3
        if: ${{ github.ref == 'refs/heads/develop' || inputs.publish_to_s3 == 'true' || github.event.inputs.publish_to_s3 == 'true' }}
        shell: pwsh
        working-directory: ${{ github.workspace }}/${{ env.OPENSTUDIO_BUILD }}
        env:
          S3_PREFIX: ${{ github.ref_type == 'tag' && format('releases/{0}/signed', github.ref_name) || format('{0}/signed', github.ref_name) }}
        run: |
          Write-Host "Uploading artifacts to s3://$env:AWS_S3_BUCKET/$env:S3_PREFIX"

          # Upload signed installers if they exist
          if (Test-Path "signed") {
            Get-ChildItem -Path signed -Filter *.exe | ForEach-Object {
              $key = "$env:S3_PREFIX/$($_.Name)"
              aws s3 cp $_.FullName "s3://$env:AWS_S3_BUCKET/$key" --acl public-read
              Get-FileHash -Path $_.FullName -Algorithm MD5
            }
          } else {
            Write-Host "::warning::No signed directory found, uploading unsigned installers"
            Get-ChildItem -Path . -Filter OpenStudio*.exe | ForEach-Object {
              $key = "$env:S3_PREFIX/$($_.Name)"
              aws s3 cp $_.FullName "s3://$env:AWS_S3_BUCKET/$key" --acl public-read
              Get-FileHash -Path $_.FullName -Algorithm MD5
            }
          }

          # Upload ZIP packages
          Get-ChildItem -Path . -Filter *.zip -Exclude "*-${{ github.run_id }}.zip","*signed.zip","Testing*.zip" | ForEach-Object {
            $key = "$env:S3_PREFIX/$($_.Name)"
            aws s3 cp $_.FullName "s3://$env:AWS_S3_BUCKET/$key" --acl public-read
            Get-FileHash -Path $_.FullName -Algorithm MD5
          }

      - name: Fail job on test failures
        if: ${{ steps.build_and_test_steps.outputs.ctest_exit_code != '0' }}
        shell: pwsh
        run: |
          Write-Host "::error::CTest suite failed with exit code ${{ steps.build_and_test_steps.outputs.ctest_exit_code }}"
          exit 1
